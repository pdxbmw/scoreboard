<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Junior Scoreboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f4f7f6; --card-bg: #ffffff; --primary: #333; }
        body { font-family: 'Fredoka', sans-serif; background: var(--bg); margin: 0; padding-bottom: 40px; }
        .date-nav { background: #fff; padding: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .nav-btn { background: #f0f0f0; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 1.2rem; cursor: pointer; }
        .nav-btn:hover { background: #e0e0e0; }
        .current-date { font-size: 1.1rem; font-weight: 600; color: #333; }
        .filters { display: flex; gap: 8px; overflow-x: auto; padding: 15px 15px 5px 15px; -webkit-overflow-scrolling: touch; justify-content: center; flex-wrap: wrap; }
        .filter-btn { background: #fff; border: 1px solid var(--dot); border-radius: 999px; padding: 8px 12px; font-weight: 600; font-size: 0.9rem; cursor: pointer; white-space: nowrap; color: var(--dot); display: inline-flex; align-items: center; gap: 6px; --dot:#555; }
        .filter-btn .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--dot); display: inline-block; }
        .filter-btn.active { background: var(--dot); color: #fff; border-color: var(--dot); }
        .filter-btn.active .dot { background: #fff; }
        .filter-btn.no-dot { gap: 0; --dot:#555; border-color: #ddd; color: #555; }
        .filter-btn.no-dot .dot { display: none; }
        .filter-btn.no-dot.active { background: #444; border-color: #444; color: #fff; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding: 20px; max-width: 1400px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: 24px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .card.completed { opacity: 0.7; }
        .card.completed .score { color: #666; }
        .card.completed .status { background: #e8e8e8; color: #999; }
        .matchup { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .team { display: flex; flex-direction: column; align-items: center; flex: 1; cursor: pointer; } 
        .team img { width: 55px; height: 55px; object-fit: contain; }
        .team-name { font-size: 0.85rem; margin-top: 5px; text-align: center; }
        .rank-badge { display: inline-block; background: transparent; color: #999; border-radius: 4px; padding: 0 2px; font-size: 0.7rem; font-weight: 500; margin-right: 2px; vertical-align: baseline; letter-spacing: 0; }
        .record { font-size: 0.75rem; color: #888; }
        .score-board { text-align: center; flex: 0 0 85px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .score { font-size: 1.8rem; font-weight: 600; color: #333; white-space: nowrap; }
        .score.at-symbol { font-size: 1.2rem; letter-spacing: 1px; color: #c2c2c2; }
        .status { font-size: 0.78rem; color: #666; background: #f0f0f0; padding: 4px 10px; border-radius: 10px; white-space: nowrap; display: inline-block; }
        .league-pill { font-size: 0.68rem; font-weight: 600; color: #555; padding: 3px 8px; border-radius: 999px; display: inline-flex; align-items: center; gap: 6px; letter-spacing: 0.2px; background: #f9f9f9; border: 1px solid #e0e0e0; }
        .league-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .live { background: #ff4444; color: white; animation: pulse 2s infinite; }
        .live-text { color: #fff; font-size: 0.85rem; font-weight: bold; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>
    <div class="date-nav">
        <button class="nav-btn" onclick="changeDate(-1)">‚Üê</button>
        <div class="current-date" id="dateDisplay">Today</div>
        <button class="nav-btn" onclick="changeDate(1)">‚Üí</button>
    </div>
    <div class="filters">
        <button class="filter-btn no-dot active" onclick="filter('ALL', this)">All</button>
        <button class="filter-btn" style="--dot:#0b5f8a" onclick="filter('nfl', this)"><span class="dot"></span>NFL</button>
        <button class="filter-btn" style="--dot:#8b3f0a" onclick="filter('ncaa_fb', this)"><span class="dot"></span>NCAA FB</button>
        <button class="filter-btn" style="--dot:#1d428a" onclick="filter('nba', this)"><span class="dot"></span>NBA</button>
        <button class="filter-btn" style="--dot:#e46b0c" onclick="filter('wnba', this)"><span class="dot"></span>WNBA</button>
        <button class="filter-btn" style="--dot:#006847" onclick="filter('ncaa_mb', this)"><span class="dot"></span>NCAA Men</button>
        <button class="filter-btn" style="--dot:#7d0068" onclick="filter('ncaa_wb', this)"><span class="dot"></span>NCAA Women</button>
    </div>
    <div class="grid" id="app">Loading...</div>
    <script>
        let allData = {}, dateKeys = [], currentIndex = 0, currentFilter = 'ALL', autoRefreshInterval;

        const LEAGUE_META = {
            nfl:  { label: 'NFL',  color: '#0b5f8a' },
            ncaa_fb: { label: 'NCAA FB', color: '#8b3f0a' },
            nba:  { label: 'NBA',  color: '#1d428a' },
            wnba: { label: 'WNBA', color: '#e46b0c' },
            ncaa_mb: { label: 'NCAA M', color: '#006847' },
            ncaa_wb: { label: 'NCAA W', color: '#7d0068' },
        };

        const normalizeRank = (r) => {
            const n = Number(r);
            return Number.isFinite(n) && n > 0 && n <= 50 ? n : null;
        };

        const ESPN_ENDPOINTS = {
            nba: `https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard?dates=` ,
            ncaa_mb: `https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/scoreboard?dates=` ,
            ncaa_wb: `https://site.api.espn.com/apis/site/v2/sports/basketball/womens-college-basketball/scoreboard?dates=` ,
        };

        function hexToRgba(hex, alpha = 0.12) {
            if (!hex || typeof hex !== 'string') return `rgba(0,0,0,${alpha})`;
            let h = hex.replace('#','');
            if (h.length === 3) h = h.split('').map(c => c + c).join('');
            const num = parseInt(h, 16);
            const r = (num >> 16) & 255;
            const g = (num >> 8) & 255;
            const b = num & 255;
            return `rgba(${r},${g},${b},${alpha})`;
        }

        function parseLocalStatusTime(dateKey, status, isoDate) {
            // Prefer ISO date if provided (has timezone/UTC offset)
            if (isoDate) {
                const dIso = new Date(isoDate);
                if (!isNaN(dIso.getTime())) {
                    return dIso.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                }
            }
            if (!status || !dateKey) return null;
            const timeMatch = status.match(/(\d{1,2}:\d{2}\s*[AP]M)/i);
            if (!timeMatch) return null;
            const tzMatch = status.match(/\b(ET|EST|EDT|CT|CST|CDT|MT|MST|MDT|PT|PST|PDT)\b/i);
            const tz = tzMatch ? tzMatch[1].toUpperCase() : null;
            const offsets = {
                ET: -5, EST: -5, EDT: -4,
                CT: -6, CST: -6, CDT: -5,
                MT: -7, MST: -7, MDT: -6,
                PT: -8, PST: -8, PDT: -7
            };
            const year = parseInt(dateKey.substring(0, 4), 10);
            const month = parseInt(dateKey.substring(4, 6), 10);
            const day = parseInt(dateKey.substring(6, 8), 10);
            const timePart = timeMatch[1].replace(/\s+/g, ' ').trim();
            const [hm, ampm] = timePart.split(/\s+/);
            const [hStr, mStr] = hm.split(':');
            let hour = parseInt(hStr, 10);
            const minute = parseInt(mStr, 10);
            if (ampm.toUpperCase() === 'PM' && hour !== 12) hour += 12;
            if (ampm.toUpperCase() === 'AM' && hour === 12) hour = 0;
            const offset = tz ? (offsets[tz] ?? -5) : -5; // default ET
            const utcMs = Date.UTC(year, month - 1, day, hour - offset, minute);
            const dLocal = new Date(utcMs);
            if (isNaN(dLocal.getTime())) return null;
            return dLocal.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        }
        
        async function init() {
            try {
                // Check if today and load ESPN data, otherwise load scraped data
                const urlParams = new URLSearchParams(window.location.search);
                const paramDate = urlParams.get('d');
                const today = new Date();
                const todayStr = today.getFullYear().toString() + 
                    (today.getMonth() + 1).toString().padStart(2, '0') + 
                    today.getDate().toString().padStart(2, '0');
                const initialDateStr = paramDate || todayStr;
                console.log('üìÖ Today is:', todayStr, 'initial:', initialDateStr);
                
                // Try to load scraped data first to get date structure
                const res = await fetch('data/scores.json?t=' + Date.now());
                const scrapedData = await res.json();
                // Ensure scraped data has start_local for scheduled games
                allData = scrapedData;
                Object.values(allData).forEach(dayGames => {
                    dayGames.forEach(g => {
                        if (!g.start_local && g.date) {
                            try {
                                g.start_local = new Date(g.date).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                            } catch (e) {}
                        }
                    });
                });
                dateKeys = Object.keys(allData).sort();
                currentIndex = dateKeys.indexOf(initialDateStr);
                
                // If today missing, create it from ESPN
                if (currentIndex === -1) {
                    console.log('üìÖ Initial date missing in scraped data, fetching ESPN for today');
                    const espnGames = await updateTodayWithESPN(todayStr);
                    if (espnGames && espnGames.length >= 0) {
                        allData[todayStr] = espnGames;
                        dateKeys = Object.keys(allData).sort();
                        currentIndex = dateKeys.indexOf(todayStr);
                    }
                    if (currentIndex === -1) currentIndex = Math.floor(dateKeys.length / 2);
                } else {
                    // Date exists: refresh today with ESPN if available
                    console.log('üìÖ Initial date found in scraped data, updating today with ESPN data');
                    const espnGames = await updateTodayWithESPN(todayStr);
                    if (espnGames && espnGames.length >= 0) {
                        allData[todayStr] = espnGames;
                    }
                }
                
                render();
                startAutoRefresh();
            } catch (e) { 
                console.error('Init error:', e);
                document.getElementById('app').innerHTML = "<p align='center'>Updating stats...</p>"; 
            }
        }

        async function updateTodayWithESPN(todayStr) {
            const existing = allData[todayStr] || [];
            const leaguesToUpdate = new Set(existing.map(g => g.league_key).filter(k => ESPN_ENDPOINTS[k]));
            if (leaguesToUpdate.size === 0) leaguesToUpdate.add('nba');

            const parsedGames = [];
            for (const leagueKey of leaguesToUpdate) {
                const endpoint = ESPN_ENDPOINTS[leagueKey];
                if (!endpoint) continue;
                try {
                    console.log(`üîÑ Fetching ESPN ${leagueKey} for today`);
                    const res = await fetch(`${endpoint}${todayStr}`);
                    const data = await res.json();
                    if (!data.events || data.events.length === 0) continue;
                    for (const event of data.events) {
                        const comp = event.competitions?.[0];
                        if (!comp) continue;
                        const status = comp.status?.type?.shortDetail || comp.status?.type?.detail || '';
                        const home = comp.competitors?.[0];
                        const away = comp.competitors?.[1];
                        if (!home || !away) continue;
                        const startLocal = new Date(event.date).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                        parsedGames.push({
                            id: event.id,
                            league: LEAGUE_META[leagueKey]?.label || leagueKey.toUpperCase(),
                            league_key: leagueKey,
                            status,
                            completed: comp.status?.type?.completed || false,
                            date: event.date,
                            start_local: startLocal,
                            home: {
                                id: home.team?.id,
                                name: home.team?.displayName,
                                logo: home.team?.logos?.[0]?.href || home.team?.logo || '',
                                color: "#" + (home.team?.color || '333333'),
                                record: home.records?.[0]?.summary || '0-0',
                                rank: normalizeRank(home.curatedRank?.current || home.rank)
                            },
                            away: {
                                id: away.team?.id,
                                name: away.team?.displayName,
                                logo: away.team?.logos?.[0]?.href || away.team?.logo || '',
                                color: "#" + (away.team?.color || '333333'),
                                record: away.records?.[0]?.summary || '0-0',
                                rank: normalizeRank(away.curatedRank?.current || away.rank)
                            }
                        });
                    }
                } catch (e) {
                    console.log(`‚ö†Ô∏è ESPN fetch failed for ${leagueKey}:`, e);
                }
            }

            // Keep leagues we didn't refresh, replace those we did
            const kept = existing.filter(g => !leaguesToUpdate.has(g.league_key));
            allData[todayStr] = [...kept, ...parsedGames];
            console.log('‚úÖ Updated today with ESPN data:', parsedGames.length, 'games; kept existing:', kept.length);
            return allData[todayStr];
        }

        function isLiveGame(game) {
            if (game.completed) return false;
            const status = (game.status || '').toLowerCase();
            if (status.includes('in progress')) return true;
            if (status.includes('1st') || status.includes('2nd') || status.includes('3rd') || status.includes('4th')) return true;
            if (status.includes('quarter') || status.includes('half') || status.includes('period') || status.includes('ot')) return true;
            // NCAA detail strings like "10:21 - 1st"
            if (/\d+:\d+\s*-\s*\d+(st|nd|rd|th)/i.test(status)) return true;
            // Any clock without AM/PM likely live (e.g., "12:05")
            if (/\d+:\d+/.test(status) && !status.includes('am') && !status.includes('pm')) return true;
            return false;
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                const today = new Date();
                const todayStr = today.getFullYear().toString() + 
                    (today.getMonth() + 1).toString().padStart(2, '0') + 
                    today.getDate().toString().padStart(2, '0');
                const dateKey = dateKeys[currentIndex];
                if (dateKey === todayStr) {
                    // Always refresh today to pick up newly-live games
                    init();
                    return;
                }
                // For other days, only refresh if any game is live
                const hasLiveGames = checkForLiveGames();
                if (hasLiveGames) {
                    init();
                }
            }, 30000);
        }

        function checkForLiveGames() {
            for (const dateKey in allData) {
                for (const game of allData[dateKey]) {
                    if (isLiveGame(game)) return true;
                }
            }
            return false;
        }

        function render() {
            const dateKey = dateKeys[currentIndex];
            const games = allData[dateKey] || [];
            
            // Fix date display - use formatted date instead of games[0].date_label
            const year = parseInt(dateKey.substring(0, 4));
            const month = parseInt(dateKey.substring(4, 6)) - 1; // JS months are 0-indexed
            const day = parseInt(dateKey.substring(6, 8));
            const date = new Date(year, month, day);
            const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
            
            document.getElementById('dateDisplay').innerText = formattedDate;
            
            const container = document.getElementById('app');
            container.innerHTML = '';
            
            const filteredGames = games.filter(g => currentFilter === 'ALL' || g.league_key === currentFilter)
                .map(g => {
                    if (!g.start_local && g.date) {
                        const d = new Date(g.date);
                        if (!isNaN(d.getTime())) {
                            g.start_local = d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                        }
                    }
                    return g;
                });
            if(filteredGames.length === 0) { container.innerHTML = "<p align='center' style='color:#888;'>No games.</p>"; return; }

            filteredGames.forEach(game => {
                const div = document.createElement('div');
                div.className = 'card';
                if (game.completed) div.classList.add('completed');
                div.style.setProperty('--home-color', game.home.color);
                div.style.setProperty('--away-color', game.away.color);
                if (game.completed) {
                    if (parseInt(game.home.score) > parseInt(game.away.score)) div.classList.add('winner-home');
                    else div.classList.add('winner-away');
                }
                
                // Make entire card clickable to go to game page (we can get ESPN data for any game)
                div.style.cursor = 'pointer';
                div.onclick = () => location.href = `game.html?id=${game.id}&league=${game.league_key || ''}&homeColor=${encodeURIComponent(game.home.color)}&awayColor=${encodeURIComponent(game.away.color)}`;
                
                // Check if game is live and extract time
                const isLive = isLiveGame(game);

                const awayScoreVal = game.away?.score ?? game.away?.score?.value ?? '0';
                const homeScoreVal = game.home?.score ?? game.home?.score?.value ?? '0';
                const awayScoreStr = String(awayScoreVal);
                const homeScoreStr = String(homeScoreVal);

                const awayRank = normalizeRank(game.away?.rank);
                const homeRank = normalizeRank(game.home?.rank);
                
                let displayStatus = game.status;
                if (isLive && /\d+:\d+\s*-\s*\d+(st|nd|rd|th)/.test(game.status)) {
                    const timeMatch = game.status.match(/(\d+:\d+)/);
                    const quarterNum = game.status.match(/(\d+)(?:st|nd|rd|th)/);
                    if (timeMatch && quarterNum) {
                        displayStatus = `Q${quarterNum[1]}<br><span class="live-text">${timeMatch[1]}</span>`;
                    }
                } else if (!game.completed) {
                    const parsedLocal = parseLocalStatusTime(dateKey, game.status, game.date);
                    if (game.start_local) {
                        displayStatus = game.start_local;
                    } else if (parsedLocal) {
                        displayStatus = parsedLocal;
                    } else {
                        const timeOnly = (game.status || '').match(/(\d{1,2}:\d{2}\s*[AP]M)/i);
                        displayStatus = timeOnly ? timeOnly[1].replace(/\s+/g,' ').trim() : game.status;
                    }
                }
                
                const leagueMeta = LEAGUE_META[game.league_key] || { label: game.league || 'SPORT', color: '#888' };
                const badgeBg = hexToRgba(leagueMeta.color, 0.12);
                div.innerHTML = `
                    <div class="matchup">
                        <div class="team">
                            <img src="${game.away.logo}">
                            <div class="team-name">${awayRank ? `<span class='rank-badge'>#${awayRank}</span>` : ''}${game.away.name}</div>
                            <div class="record">${game.away.record}</div>
                        </div>
                        <div class="score-board">
                            <span class="league-pill" style="border-color:${leagueMeta.color}; background:${badgeBg}"><span class="league-dot" style="background:${leagueMeta.color}"></span>${leagueMeta.label}</span>
                            <span class="${awayScoreStr === '0' && homeScoreStr === '0' ? 'score at-symbol' : 'score'}">${awayScoreStr === '0' && homeScoreStr === '0' ? '@' : `${awayScoreStr}-${homeScoreStr}`}</span>
                            <div class="status ${isLive ? 'live' : ''}">${displayStatus}</div>
                        </div>
                        <div class="team">
                            <img src="${game.home.logo}">
                            <div class="team-name">${homeRank ? `<span class='rank-badge'>#${homeRank}</span>` : ''}${game.home.name}</div>
                            <div class="record">${game.home.record}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function filter(key, el) { 
            currentFilter = key; 
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); 
            if (el) el.classList.add('active');
            render(); 
        }
        
        function changeDate(delta) { 
            const newIndex = currentIndex + delta; 
            if (newIndex >= 0 && newIndex < dateKeys.length) { 
                currentIndex = newIndex; 
                const dateKey = dateKeys[currentIndex];
                const url = new URL(window.location.href);
                url.searchParams.set('d', dateKey);
                window.history.replaceState({}, '', url.toString());
                render(); 
            }
        }
        
        init();
    </script>
</body>
</html>