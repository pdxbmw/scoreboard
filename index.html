<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Junior Scoreboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f4f7f6; --card-bg: #ffffff; --primary: #333; }
        body { font-family: 'Fredoka', sans-serif; background: var(--bg); margin: 0; padding-bottom: 40px; }
        .date-nav { background: #fff; padding: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .nav-btn { background: #f0f0f0; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 1.2rem; cursor: pointer; }
        .nav-btn:hover { background: #e0e0e0; }
        .current-date { font-size: 1.1rem; font-weight: 600; color: #333; }
        .filters { display: flex; gap: 8px; overflow-x: auto; padding: 15px 15px 5px 15px; -webkit-overflow-scrolling: touch; justify-content: center; flex-wrap: wrap; }
        .filter-btn { background: white; border: 1px solid #ddd; border-radius: 20px; padding: 8px 14px; font-weight: 600; font-size: 0.9rem; cursor: pointer; white-space: nowrap; color: #555; }
        .filter-btn.active { background: #333; color: white; border-color: #333; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding: 20px; }
        .card { background: var(--card-bg); border-radius: 24px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .card.completed { opacity: 0.7; }
        .card.completed .score { color: #666; }
        .card.completed .status { background: #e8e8e8; color: #999; }
        .matchup { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .team { display: flex; flex-direction: column; align-items: center; flex: 1; cursor: pointer; } 
        .team img { width: 55px; height: 55px; object-fit: contain; }
        .team-name { font-size: 0.85rem; margin-top: 5px; text-align: center; }
        .record { font-size: 0.75rem; color: #888; }
        .score-board { text-align: center; flex: 0 0 85px; cursor: pointer; }
        .score { font-size: 1.8rem; font-weight: 600; color: #333; }
        .status { font-size: 0.75rem; color: #999; background: #eee; padding: 2px 8px; border-radius: 8px; }
        .live { background: #ff4444; color: white; animation: pulse 2s infinite; }
        .live-text { color: #ff4444; font-weight: bold; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>
    <div class="date-nav">
        <button class="nav-btn" onclick="changeDate(-1)">‚Üê</button>
        <div class="current-date" id="dateDisplay">Today</div>
        <button class="nav-btn" onclick="changeDate(1)">‚Üí</button>
    </div>
    <div class="filters">
        <button class="filter-btn active" onclick="filter('ALL')">üåç All</button>
        <button class="filter-btn" onclick="filter('nfl')">üèà NFL</button>
        <button class="filter-btn" onclick="filter('ncaa_fb')">üèà NCAA FB</button>
        <button class="filter-btn" onclick="filter('nba')">üèÄ NBA</button>
        <button class="filter-btn" onclick="filter('wnba')">üèÄ WNBA</button>
        <button class="filter-btn" onclick="filter('ncaa_mb')">üèÄ NCAA Men</button>
        <button class="filter-btn" onclick="filter('ncaa_wb')">üèÄ NCAA Women</button>
    </div>
    <div class="grid" id="app">Loading...</div>
    <script>
        let allData = {}, dateKeys = [], currentIndex = 0, currentFilter = 'ALL', autoRefreshInterval;
        
        async function init() {
            try {
                // Check if today and load ESPN data, otherwise load scraped data
                const today = new Date();
                const todayStr = today.getFullYear().toString() + 
                    (today.getMonth() + 1).toString().padStart(2, '0') + 
                    today.getDate().toString().padStart(2, '0');
                console.log('üìÖ Today is:', todayStr);
                
                // Try to load scraped data first to get date structure
                const res = await fetch('data/scores.json?t=' + Date.now());
                const scrapedData = await res.json();
                allData = scrapedData;
                dateKeys = Object.keys(allData).sort();
                currentIndex = dateKeys.indexOf(todayStr);
                if (currentIndex === -1) currentIndex = Math.floor(dateKeys.length / 2);
                
                // If today exists in scraped data, try to update it with ESPN data
                if (dateKeys.includes(todayStr)) {
                    console.log('üìÖ Today found in scraped data, updating with ESPN data');
                    await updateTodayWithESPN(todayStr);
                }
                
                render();
                startAutoRefresh();
            } catch (e) { 
                console.error('Init error:', e);
                document.getElementById('app').innerHTML = "<p align='center'>Updating stats...</p>"; 
            }
        }

        async function updateTodayWithESPN(todayStr) {
            try {
                console.log('üîÑ Fetching ESPN data for today');
                const url = 'https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard';
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.events && data.events.length > 0) {
                    const espnGames = [];
                    for (const event of data.events) {
                        const comp = event.competitions[0];
                        const status = comp.status?.type?.shortDetail || '';
                        const home = comp.competitors[0];
                        const away = comp.competitors[1];
                        
                        const gameData = {
                            id: event.id,
                            league: "NBA",
                            league_key: "nba",
                            status: status,
                            completed: comp.status?.type?.completed || false,
                            home: {
                                id: home.team.id,
                                name: home.team.shortDisplayName,
                                score: home.score,
                                logo: home.team.logos?.[0]?.href || home.team.logo || '',
                                color: "#" + (home.team.color || '333333'),
                                record: home.records?.[0]?.summary || '0-0'
                            },
                            away: {
                                id: away.team.id,
                                name: away.team.shortDisplayName,
                                score: away.score,
                                logo: away.team.logos?.[0]?.href || away.team.logo || '',
                                color: "#" + (away.team.color || '333333'),
                                record: away.records?.[0]?.summary || '0-0'
                            }
                        };
                        espnGames.push(gameData);
                    }
                    
                    // Update today's data with ESPN data
                    allData[todayStr] = espnGames;
                    console.log('‚úÖ Updated today with ESPN data:', espnGames.length, 'games');
                }
            } catch (e) {
                console.log('‚ö†Ô∏è Could not fetch ESPN data, using scraped data:', e);
            }
        }

        function startAutoRefresh() {
            // Check for live games and refresh every 30 seconds if found
            autoRefreshInterval = setInterval(() => {
                const hasLiveGames = checkForLiveGames();
                if (hasLiveGames) {
                    init(); // Refresh data
                }
            }, 30000);
        }

        function checkForLiveGames() {
            for (const dateKey in allData) {
                for (const game of allData[dateKey]) {
                    if (!game.completed && (game.status.includes('PM') || game.status.includes('AM') || game.status.includes('ET') || game.status.includes('PT'))) {
                        return true;
                    }
                }
            }
            return false;
        }

        function render() {
            const dateKey = dateKeys[currentIndex];
            const games = allData[dateKey] || [];
            
            // Fix date display - use formatted date instead of games[0].date_label
            const year = parseInt(dateKey.substring(0, 4));
            const month = parseInt(dateKey.substring(4, 6)) - 1; // JS months are 0-indexed
            const day = parseInt(dateKey.substring(6, 8));
            const date = new Date(year, month, day);
            const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
            
            document.getElementById('dateDisplay').innerText = formattedDate;
            
            const container = document.getElementById('app');
            container.innerHTML = '';
            
            const filteredGames = games.filter(g => currentFilter === 'ALL' || g.league_key === currentFilter);
            if(filteredGames.length === 0) { container.innerHTML = "<p align='center' style='color:#888;'>No games.</p>"; return; }

            filteredGames.forEach(game => {
                const div = document.createElement('div');
                div.className = 'card';
                if (game.completed) div.classList.add('completed');
                div.style.setProperty('--home-color', game.home.color);
                div.style.setProperty('--away-color', game.away.color);
                if (game.completed) {
                    if (parseInt(game.home.score) > parseInt(game.away.score)) div.classList.add('winner-home');
                    else div.classList.add('winner-away');
                }
                
                // Make entire card clickable to go to game page (we can get ESPN data for any game)
                div.style.cursor = 'pointer';
                div.onclick = () => location.href = `game.html?id=${game.id}&homeColor=${encodeURIComponent(game.home.color)}&awayColor=${encodeURIComponent(game.away.color)}`;
                
                // Check if game is live and extract time
                const isLive = !game.completed && (
                    game.status.includes('Q1') || game.status.includes('Q2') || 
                    game.status.includes('Q3') || game.status.includes('Q4') ||
                    game.status.includes('Halftime') || game.status.includes('OT') ||
                    /\d+:\d+\s*-\s*\d+(st|nd|rd|th)/.test(game.status)
                );
                
                let displayStatus = game.status;
                if (isLive && /\d+:\d+\s*-\s*\d+(st|nd|rd|th)/.test(game.status)) {
                    // Extract time and quarter, format as "Q2\n7:31" (quarter above time)
                    const timeMatch = game.status.match(/(\d+:\d+)/);
                    const quarterNum = game.status.match(/(\d+)(?:st|nd|rd|th)/);
                    if (timeMatch && quarterNum) {
                        displayStatus = `Q${quarterNum[1]}<br><span class="live-text">${timeMatch[1]}</span>`;
                    }
                }
                
                div.innerHTML = `
                    <div class="matchup">
                        <div class="team">
                            <img src="${game.away.logo}">
                            <div class="team-name">${game.away.name}</div>
                            <div class="record">${game.away.record}</div>
                        </div>
                        <div class="score-board">
                            <span class="score">${game.away.score === '0' && game.home.score === '0' ? '@' : `${game.away.score}-${game.home.score}`}</span>
                            <div class="status">${displayStatus}</div>
                        </div>
                        <div class="team">
                            <img src="${game.home.logo}">
                            <div class="team-name">${game.home.name}</div>
                            <div class="record">${game.home.record}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function filter(key) { 
            currentFilter = key; 
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); 
            event.currentTarget.classList.add('active'); 
            render(); 
        }
        
        function changeDate(delta) { 
            const newIndex = currentIndex + delta; 
            if (newIndex >= 0 && newIndex < dateKeys.length) { 
                currentIndex = newIndex; 
                render(); 
            }
        }
        
        init();
    </script>
</body>
</html>