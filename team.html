<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team History</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Fredoka', sans-serif; background: #f4f7f6; margin: 0; padding: 0; }
        
        /* Dynamic Header */
        .header {
            background: var(--team-color, #333); color: white; padding: 30px 20px;
            text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100;
        }
        .header h1 { margin: 10px 0 5px 0; font-size: 2.5rem; }
        .header-content { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-left: 100px; }
        .back-btn { 
            position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); 
            color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer;
            text-decoration: none; font-size: 1rem;
        }

        /* List of Games */
        .game-list { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .game-row {
            background: white; border-radius: 15px; padding: 15px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .game-date { font-size: 0.8rem; color: #888; width: 80px; white-space: nowrap; }
        .opponent { display: flex; align-items: center; justify-content: center; gap: 10px; flex: 1; }
        .opponent img { width: 40px; height: 40px; object-fit: contain; }
        .opponent-name { font-weight: bold; color: #333; }
        .result { font-size: 1.2rem; font-weight: bold; width: 80px; text-align: right; white-space: nowrap; }
        
        .win { color: #2e7d32; } /* Green */
        .loss { color: #c62828; } /* Red */
        .future { color: #555; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="header" id="header">
        <a href="index.html" class="back-btn">‚Üê Back</a>
        <div class="header-content">
            <h1 id="teamName">Loading...</h1>
            <div id="teamRecord" style="font-size: 1rem; opacity: 0.9;"></div>
        </div>
    </div>

    <div class="game-list" id="games">
        <p align="center">Fetching full season history...</p>
    </div>

    <script>
        // Parse URL params
        const params = new URLSearchParams(window.location.search);
        const TEAM_ID = params.get('id');
        const COLOR = decodeURIComponent(params.get('color'));
        const NAME = params.get('name');
        const LEAGUE = params.get('league');

        // Apply Theme
        document.getElementById('header').style.setProperty('--team-color', COLOR);
        document.getElementById('teamName').innerText = NAME || "Team Schedule";

        let refreshTimer;

        const LEAGUE_PATHS = {
            nba: 'basketball/nba',
            ncaa_mb: 'basketball/mens-college-basketball',
            ncaa_wb: 'basketball/womens-college-basketball'
        };

        async function fetchTeamFromAPI() {
            const leaguePath = LEAGUE_PATHS[LEAGUE] || LEAGUE_PATHS.nba;
            const base = `https://site.api.espn.com/apis/site/v2/sports/${leaguePath}`;
            try {
                const [teamRes, scheduleRes] = await Promise.all([
                    fetch(`${base}/teams/${TEAM_ID}`),
                    fetch(`${base}/teams/${TEAM_ID}/schedule`)
                ]);
                if (!teamRes.ok || !scheduleRes.ok) throw new Error(`HTTP ${teamRes.status}/${scheduleRes.status}`);
                const teamJson = await teamRes.json();
                const schedJson = await scheduleRes.json();
                const teamRecord = teamJson.team?.record?.items?.[0]?.summary || teamJson.team?.recordSummary || '';
                const events = schedJson?.team?.events || [];
                return { teamRecord, events };
            } catch (e) {
                console.log('API fallback failed:', e);
                return null;
            }
        }

        const formatLocal = (iso) => {
            const d = new Date(iso);
            if (isNaN(d.getTime())) return '';
            const dateStr = `${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}, ${d.getFullYear()}`;
            const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return { dateStr, timeStr };
        };

        async function loadHistory() {
            // FIX: Load from our LOCAL folder, not ESPN directly
            const url = `data/teams/${TEAM_ID}.json`;
            console.log('Fetching from:', url);
            
            try {
                const res = await fetch(url);
                console.log('Response status:', res.status);
                let events = [];
                let teamRecord = '';

                if (res.ok) {
                    const data = await res.json();
                    console.log('Data keys:', Object.keys(data));
                    events = (data.events || []).filter(ev => {
                        const comp = ev.competitions?.[0];
                        const hasTeam = comp?.competitors?.some(c => c.team?.id === TEAM_ID);
                        return hasTeam;
                    });
                    console.log('Events count:', events.length);
                    teamRecord = data.team?.recordSummary || '';
                } else {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                // Fallback to ESPN API if no local data
                if ((!events || events.length === 0) || !teamRecord) {
                    console.log('Local data missing or empty, trying API fallback');
                    const apiData = await fetchTeamFromAPI();
                    if (apiData) {
                        events = apiData.events;
                        teamRecord = apiData.teamRecord || teamRecord;
                    }
                }

                document.getElementById('teamRecord').innerText = teamRecord || 'Season Record';
                renderGames(events || []);

                // set up auto-refresh to keep live scores current when we have any events
                if (refreshTimer) clearTimeout(refreshTimer);
                if (events && events.length) {
                    refreshTimer = setTimeout(loadHistory, 20000);
                }
            } catch(e) {
                console.error('Error loading team data:', e);
                const apiData = await fetchTeamFromAPI();
                if (apiData) {
                    document.getElementById('teamRecord').innerText = apiData.teamRecord || 'Season Record';
                    renderGames(apiData.events || []);
                } else {
                    const friendlyImg = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='220' height='180' viewBox='0 0 220 180'><rect width='220' height='180' rx='24' ry='24' fill='%23f5f7fb'/><circle cx='110' cy='85' r='52' fill='%23fff' stroke='%23d33' stroke-width='4'/><circle cx='90' cy='78' r='7' fill='%23d33'/><circle cx='130' cy='78' r='7' fill='%23d33'/><path d='M82 112c12-10 44-10 56 0' stroke='%23d33' stroke-width='6' fill='none' stroke-linecap='round'/></svg>";
                    document.getElementById('games').innerHTML = `
                        <div style='text-align:center; color:#444; font-size:1.05rem; padding:24px;'>
                            <img src="${friendlyImg}" alt="No games" style="width:180px; max-width:80%; display:block; margin:0 auto 10px auto;" />
                            <div style="margin-top:8px; font-weight:800;">No games here</div>
                            <div style="margin-top:4px; font-size:1rem; color:#666;">Try another team.</div>
                        </div>`;
                }
            }
        }

        async function getOpponentRecord(opponentId) {
            try {
                console.log(`Fetching record for opponent ${opponentId}`);
                const res = await fetch(`data/teams/${opponentId}.json`);
                if (res.ok) {
                    const data = await res.json();
                    const record = data.team?.recordSummary;
                    console.log(`Opponent ${opponentId} record:`, record);
                    return record || '';
                } else {
                    console.log(`Opponent ${opponentId} file not found (status: ${res.status})`);
                }
            } catch (e) {
                console.log('Could not fetch opponent record for', opponentId, e);
            }
            return '';
        }

        async function renderGames(events) {
            const container = document.getElementById('games');
            container.innerHTML = '';
            
            // Sort events by date (oldest first for chronological order)
            events.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            for (const event of events) {
                const game = event.competitions && event.competitions[0];
                if (!game) {
                    console.warn('No competition data for event:', event);
                    continue;
                }
                
                const opponent = game.competitors && game.competitors.find(c => c.team && c.team.id !== TEAM_ID);
                const myTeam = game.competitors && game.competitors.find(c => c.team && c.team.id === TEAM_ID);
                
                if (!opponent || !myTeam) {
                    console.warn('Missing team data for event:', event);
                    continue;
                }
                
                const { dateStr, timeStr } = formatLocal(event.date);
                
                const div = document.createElement('div');
                div.className = 'game-row';

                let resultHTML = "";
                // Check status at competition level
                const isCompleted = game.status && game.status.type && game.status.type.completed;
                
                if (isCompleted) {
                    const myScore = parseInt(myTeam.score?.value || 0);
                    const opScore = parseInt(opponent.score?.value || 0);
                    const isWin = myScore > opScore;
                    
                    resultHTML = `<span class="result ${isWin ? 'win' : 'loss'}">
                        ${isWin ? 'W' : 'L'} ${myScore}-${opScore}
                    </span>`;
                } else {
                    // Show game time for upcoming games (localized)
                    resultHTML = `<span class="result future">${timeStr}</span>`;
                }

                // Get opponent record from their team data
                const opponentRecord = await getOpponentRecord(opponent.team.id);

                const oppColor = opponent.team?.color ? `#${opponent.team.color}` : '#333';
                const oppName = opponent.team?.displayName || opponent.team?.shortDisplayName || opponent.team?.abbreviation || 'Team';
                
                div.innerHTML = `
                    <span class="game-date">${dateStr}</span>
                    <div class="opponent" onclick="location.href='team.html?id=${opponent.team.id}&color=${encodeURIComponent(oppColor)}&name=${encodeURIComponent(oppName)}'" style="cursor:pointer;">
                        <img src="${opponent.team.logos?.[0]?.href || ''}">
                        <div>
                            <span class="opponent-name">${opponent.team.abbreviation || opponent.team.shortDisplayName || 'Unknown'}</span>
                            ${opponentRecord ? `<div class="record">${opponentRecord}</div>` : ''}
                        </div>
                    </div>
                    ${resultHTML}
                `;
                container.appendChild(div);
            }
        }

        loadHistory();
    </script>
</body>
</html>