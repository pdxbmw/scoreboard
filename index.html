<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Junior Scoreboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f4f7f6; --card-bg: #ffffff; --primary: #333; }
        body { font-family: 'Fredoka', sans-serif; background: var(--bg); margin: 0; padding-bottom: 40px; }
        .date-nav { background: #fff; padding: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .nav-btn { background: #f0f0f0; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 1.2rem; cursor: pointer; }
        .nav-btn:hover { background: #e0e0e0; }
        .refresh-btn { background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; cursor: pointer; }
        .refresh-btn:hover { background: #45a049; }
        .refresh-btn.refreshing { background: #888; }
        .current-date { font-size: 1.1rem; font-weight: 600; color: #333; }
        .filters { display: flex; gap: 8px; overflow-x: auto; padding: 15px 15px 5px 15px; -webkit-overflow-scrolling: touch; justify-content: center; flex-wrap: wrap; }
        .filter-btn { background: white; border: 1px solid #ddd; border-radius: 20px; padding: 8px 14px; font-weight: 600; font-size: 0.9rem; cursor: pointer; white-space: nowrap; color: #555; }
        .filter-btn.active { background: #333; color: white; border-color: #333; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding: 20px; }
        .card { background: var(--card-bg); border-radius: 24px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; align-items: center; }
        .card.completed { opacity: 0.7; }
        .card.completed .score { color: #666; }
        .card.completed .status { background: #e8e8e8; color: #999; }
        .matchup { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .team { display: flex; flex-direction: column; align-items: center; flex: 1; cursor: pointer; } 
        .team img { width: 55px; height: 55px; object-fit: contain; }
        .team-name { font-size: 0.85rem; margin-top: 5px; text-align: center; }
        .record { font-size: 0.75rem; color: #888; }
        .score-board { text-align: center; flex: 0 0 85px; }
        .score { font-size: 1.8rem; font-weight: 600; color: #333; }
        .status { font-size: 0.75rem; color: #999; background: #eee; padding: 2px 8px; border-radius: 8px; }
        .live { background: #ff4444; color: white; animation: pulse 2s infinite; }
        .live-text { color: #ff4444; font-weight: bold; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .winner-home { border-bottom: 6px solid; border-bottom-color: var(--home-color); }
        .winner-away { border-bottom: 6px solid; border-bottom-color: var(--away-color); }
    </style>
</head>
<body>
    <div class="date-nav">
        <button class="nav-btn" onclick="changeDate(-1)">‚Üê</button>
        <div class="current-date" id="dateDisplay">Today</div>
        <button class="nav-btn" onclick="changeDate(1)">‚Üí</button>
    </div>
    <div class="filters">
        <button class="filter-btn active" onclick="filter('ALL')">üåç All</button>
        <button class="filter-btn" onclick="filter('nfl')">üèà NFL</button>
        <button class="filter-btn" onclick="filter('ncaa_fb')">üèà NCAA FB</button>
        <button class="filter-btn" onclick="filter('nba')">üèÄ NBA</button>
        <button class="filter-btn" onclick="filter('wnba')">üèÄ WNBA</button>
        <button class="filter-btn" onclick="filter('ncaa_mb')">üèÄ NCAA Men</button>
        <button class="filter-btn" onclick="filter('ncaa_wb')">üèÄ NCAA Women</button>
    </div>
    <div class="grid" id="app">Loading...</div>
    <script>
        let allData = {}, dateKeys = [], currentIndex = 0, currentFilter = 'ALL', autoRefreshInterval;
        
        async function init() {
            try {
                // Skip loading static data - go straight to fresh ESPN data
                console.log('üöÄ Initializing with fresh ESPN data...');
                
                // Set up empty data structure
                const todayStr = new Date().toISOString().slice(0,10).replace(/-/g,"");
                allData[todayStr] = [];
                dateKeys = [todayStr];
                currentIndex = 0;
                
                // Fetch fresh data immediately
                await refreshScores();
                
                startAutoRefresh();
            } catch (e) { 
                console.error('Init error:', e);
                document.getElementById('app').innerHTML = "<p align='center'>Updating stats...</p>"; 
            }
        }

        function startAutoRefresh() {
            // Auto-refresh every 10 seconds with live data from ESPN
            autoRefreshInterval = setInterval(() => {
                console.log('üîÑ Auto-refreshing live scores...');
                refreshScores();
            }, 10000); // Every 10 seconds
        }

        function checkForLiveGames() {
            for (const dateKey in allData) {
                for (const game of allData[dateKey]) {
                    if (!game.completed && (
                        game.status.includes('Q1') || game.status.includes('Q2') || 
                        game.status.includes('Q3') || game.status.includes('Q4') ||
                        game.status.includes('Halftime') || game.status.includes('OT')
                    )) {
                        return true;
                    }
                }
            }
            return false;
        }

        function render() {
            console.log('üé® Render function called');
            const dateKey = dateKeys[currentIndex];
            const games = allData[dateKey] || [];
            console.log(`üìÖ Rendering date: ${dateKey}, Games: ${games.length}`);
            document.getElementById('dateDisplay').innerText = games.length > 0 ? games[0].date_label : "No Games";
            const container = document.getElementById('app');
            container.innerHTML = '';
            
            const filteredGames = games.filter(g => currentFilter === 'ALL' || g.league_key === currentFilter);
            console.log(`üîç Filter: ${currentFilter}, Filtered games: ${filteredGames.length}`);
            if(filteredGames.length === 0) { container.innerHTML = "<p align='center' style='color:#888;'>No games.</p>"; return; }

            filteredGames.forEach(game => {
                const div = document.createElement('div');
                div.className = 'card';
                if (game.completed) div.classList.add('completed');
                div.style.setProperty('--home-color', game.home.color);
                div.style.setProperty('--away-color', game.away.color);
                if (game.completed) {
                    if (parseInt(game.home.score) > parseInt(game.away.score)) div.classList.add('winner-home');
                    else div.classList.add('winner-away');
                }
                
                // Make entire card clickable to go to game page
                div.style.cursor = 'pointer';
                div.onclick = () => location.href = `game.html?id=${game.id}&homeColor=${encodeURIComponent(game.home.color)}&awayColor=${encodeURIComponent(game.away.color)}`;
                
                // Check if game is live and extract time
                const isLive = !game.completed && (
                    game.status.includes('Q1') || game.status.includes('Q2') || 
                    game.status.includes('Q3') || game.status.includes('Q4') ||
                    game.status.includes('Halftime') || game.status.includes('OT') ||
                    /\d+:\d+\s*-\s*\d+(st|nd|rd|th)/.test(game.status)
                );
                
                let displayStatus = game.status;
                if (isLive && /\d+:\d+\s*-\s*\d+(st|nd|rd|th)/.test(game.status)) {
                    // Extract time and quarter, format as "Q2\n7:31" (quarter above time)
                    const timeMatch = game.status.match(/(\d+:\d+)/);
                    const quarterNum = game.status.match(/(\d+)(?:st|nd|rd|th)/);
                    if (timeMatch && quarterNum) {
                        displayStatus = `Q${quarterNum[1]}<br><span class="live-text">${timeMatch[1]}</span>`;
                    }
                }
                
                div.innerHTML = `
                    <div class="matchup">
                        <div class="team">
                            <img src="${game.away.logo}">
                            <div class="team-name">${game.away.name}</div>
                            <div class="record">${game.away.record}</div>
                        </div>
                        <div class="score-board">
                            <span class="score">${game.away.score}-${game.home.score}</span>
                            <div class="status">${displayStatus}</div>
                        </div>
                        <div class="team">
                            <img src="${game.home.logo}">
                            <div class="team-name">${game.home.name}</div>
                            <div class="record">${game.home.record}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        async function refreshScores() {
            console.log('üîÑ Starting refreshScores...');
            
            try {
                const todayStr = new Date().toISOString().slice(0,10).replace(/-/g,"");
                const leagues = [
                    {"key": "nba", "sport": "basketball", "league_slug": "nba", "name": "NBA"}
                ];
                
                let allGames = [];
                
                for (const league of leagues) {
                    try {
                        const url = `https://site.api.espn.com/apis/site/v2/sports/${league.sport}/${league.league_slug}/scoreboard`;
                        console.log(`Fetching ${league.name} from: ${url}`);
                        const res = await fetch(url);
                        const data = await res.json();
                        
                        console.log(`${league.name} response:`, data);
                        
                        for (const event of data.events || []) {
                            const comp = event.competitions[0];
                            const status = comp.status?.type?.shortDetail || '';
                            const home = comp.competitors[0];
                            const away = comp.competitors[1];
                            
                            const gameData = {
                                id: event.id,
                                league: league.name,
                                league_key: league.key,
                                status: status,
                                completed: comp.status?.type?.completed || false,
                                home: {
                                    id: home.team.id,
                                    name: home.team.shortDisplayName,
                                    score: home.score,
                                    logo: home.team.logos?.[0]?.href || home.team.logo || '',
                                    color: "#" + (home.team.color || '333333'),
                                    record: home.records?.[0]?.summary || '0-0'
                                },
                                away: {
                                    id: away.team.id,
                                    name: away.team.shortDisplayName,
                                    score: away.score,
                                    logo: away.team.logos?.[0]?.href || away.team.logo || '',
                                    color: "#" + (away.team.color || '333333'),
                                    record: away.records?.[0]?.summary || '0-0'
                                }
                            };
                            
                            allGames.push(gameData);
                            console.log(`Added game: ${gameData.away.name} @ ${gameData.home.name} - ${gameData.away.score}-${gameData.home.score}`);
                            console.log(`Home logo: ${gameData.home.logo}`);
                            console.log(`Away logo: ${gameData.away.logo}`);
                        }
                        
                    } catch (e) {
                        console.log(`‚ùå Failed to fetch ${league.name}:`, e);
                    }
                }
                
                console.log(`üìä Total games: ${allGames.length}`);
                console.log('üîÑ Updating allData with fresh games');
                
                allData[todayStr] = allGames;
                console.log('Updated allData:', allData);
                
                console.log('üé® Calling render()');
                render();
                
            } catch (e) {
                console.error('‚ùå Refresh error:', e);
            }
        }

        function filter(key) { currentFilter = key; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); event.currentTarget.classList.add('active'); render(); }
        function changeDate(delta) { const newIndex = currentIndex + delta; if (newIndex >= 0 && newIndex < dateKeys.length) { currentIndex = newIndex; render(); } }
        init();
    </script>
</body>
</html>