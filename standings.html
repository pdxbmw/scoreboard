<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Standings</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#f4f7f6; --card:#fff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:'Fredoka', sans-serif; background:var(--bg); color:#222; padding-bottom:120px; min-height:100vh; display:flex; flex-direction:column; }
    main { flex:1 0 auto; }
    header { position:sticky; top:0; background:#fff; padding:0 10px; min-height:72px; box-shadow:0 2px 10px rgba(0,0,0,0.08); z-index:10; display:flex; align-items:center; justify-content:center; gap:10px; }
    .back { position:absolute; left:16px; text-decoration:none; color:#555; font-weight:600; border:1px solid #ddd; padding:8px 12px; border-radius:0; height:100%; display:inline-flex; align-items:center; }
    h1 { margin:0; font-size:1.2rem; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:14px; padding:16px; max-width:1200px; margin:0 auto; }
    .card { background:var(--card); border-radius:16px; padding:14px; box-shadow:0 4px 12px rgba(0,0,0,0.06); }
    .card h2 { margin:0 0 8px 0; font-size:1rem; display:flex; align-items:center; gap:8px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:0.8rem; font-weight:600; border:1px solid #e0e0e0; background:#f8f8f8; color:#555; }
    table { width:100%; border-collapse:collapse; font-size:0.9rem; }
    th, td { padding:6px 4px; text-align:left; }
    th { font-size:0.78rem; color:#777; font-weight:600; border-bottom:1px solid #eee; }
    tr + tr td { border-top:1px solid #f1f1f1; }
    .rank { width:36px; color:#999; }
    .record { font-variant-numeric:tabular-nums; }
    .gb { text-align:right; color:#777; width:60px; }
    .logo { width:22px; height:22px; object-fit:contain; vertical-align:middle; }
    .filters { display:flex; gap:8px; padding:12px 16px 4px; flex-wrap:wrap; justify-content:center; }
    .filter-btn { background:#fff; border:1px solid var(--dot,#e0e0e0); border-radius:999px; padding:6px 12px; font-weight:600; font-size:0.9rem; cursor:pointer; color:var(--dot,#555); display:inline-flex; align-items:center; gap:6px; }
    .filter-btn .dot { width:8px; height:8px; border-radius:50%; background:var(--dot,#555); display:inline-block; }
    .filter-btn.no-dot .dot { display:none; }
    .filter-btn.active { background:var(--dot,#111); border-color:var(--dot,#111); color:#fff; }
    .filter-btn.active .dot { background:#fff; }
    .team-link { color: inherit; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
    .team-link:hover { text-decoration: underline; }
    .bottom-nav { position:fixed; left:0; right:0; bottom:0; width:100%; background:#fff; box-shadow:0 -2px 10px rgba(0,0,0,0.08); padding:10px; display:flex; gap:10px; z-index:9; }
    .bottom-nav a { flex:1; text-decoration:none; text-align:center; padding:12px; border-radius:12px; font-weight:700; }
    .bottom-nav a.primary { background:#111; color:#fff; }
    .bottom-nav a.secondary { background:#f0f0f0; color:#111; }
  </style>
</head>
<body>
  <header>
    <a class="back" href="index.html">← Back</a>
    <h1>Standings</h1>
  </header>
  <main>
    <div class="filters" id="filters"></div>
    <div class="grid" id="standings">Loading...</div>
  </main>

  <div class="bottom-nav">
    <a class="secondary" href="index.html" id="nav-scoreboard">Scoreboard</a>
    <a class="primary" href="standings.html" id="nav-standings">Standings</a>
  </div>

  <script>
    const LEAGUES = [
      { key:'nba', label:'NBA', endpoint:'https://site.api.espn.com/apis/v2/sports/basketball/nba/standings', color:'#1d428a' },
      { key:'ncaa_mb', label:'NCAA Men', endpoint:'https://site.api.espn.com/apis/v2/sports/basketball/mens-college-basketball/standings', color:'#006847' },
      { key:'ncaa_wb', label:'NCAA Women', endpoint:'https://site.api.espn.com/apis/v2/sports/basketball/womens-college-basketball/standings', color:'#7d0068' }
    ];

    const standingsContainer = document.getElementById('standings');
    const filtersEl = document.getElementById('filters');
    let standingsData = {};
    let currentFilter = 'all';

    const statValue = (stats, name) => {
      const s = stats?.find(x => x.name === name);
      return s?.displayValue ?? s?.value ?? null;
    };

    const rankValue = (stats) => {
      const r = statValue(stats, 'rank');
      const n = Number(r);
      return Number.isFinite(n) && n > 0 && n <= 50 ? n : null;
    };

    async function fetchLeague(league) {
      try {
        const res = await fetch(league.endpoint);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      } catch (e) {
        console.error('Failed to fetch standings for', league.key, e);
        return null;
      }
    }

    function renderLeague(league, data) {
      if (!data || !Array.isArray(data.children)) return [];
      const cards = [];
      data.children.forEach((group, groupIdx) => {
        const groupName = group.name || group.abbreviation || `${league.label} Group ${groupIdx+1}`;
        const entries = group?.standings?.entries || [];
        const rows = [...entries]
          .map((entry, idx) => {
            const team = entry.team;
            const stats = entry.stats || [];
            const wins = statValue(stats, 'wins') || '0';
            const losses = statValue(stats, 'losses') || '0';
            const gb = statValue(stats, 'gamesBehind') || statValue(stats, 'gamesBack') || '-';
            const rk = rankValue(stats);
            return { 
              name: team?.displayName || team?.name || 'Team',
              record:`${wins}-${losses}`,
              gb,
              rank: rk ?? idx + 1,
              logo: team?.logos?.[0]?.href || '',
              id: team?.id,
              color: team?.color ? `#${team.color}` : '#333',
              winsNum: Number(wins) || 0,
              lossesNum: Number(losses) || 0,
            };
          })
          .sort((a,b) => b.winsNum - a.winsNum || a.lossesNum - b.lossesNum || (a.rank || 999) - (b.rank || 999) || a.name.localeCompare(b.name))
          .map((row, sortedIdx) => ({ ...row, displayRank: sortedIdx + 1 }));

        const tableRows = rows.map(r => {
          const href = r.id ? `team.html?id=${r.id}&league=${league.key}&color=${encodeURIComponent(r.color)}&name=${encodeURIComponent(r.name)}` : null;
          const content = `${r.logo ? `<img class="logo" src="${r.logo}">` : ''}${r.name}`;
          return `
            <tr>
              <td class="rank">${r.displayRank ? '#' + r.displayRank : ''}</td>
              <td>${href ? `<a class="team-link" href="${href}">${content}</a>` : content}</td>
              <td class="record">${r.record}</td>
              <td class="gb">${r.gb}</td>
            </tr>
          `;
        }).join('');

        cards.push(`
          <div class="card">
            <h2><span class="pill" style="border-color:${league.color}30; background:${league.color}12; color:${league.color}">● ${league.label}${groupName ? ' — ' + groupName : ''}</span></h2>
            <table>
              <thead><tr><th>#</th><th>Team</th><th>W-L</th><th class="gb">GB</th></tr></thead>
              <tbody>${tableRows}</tbody>
            </table>
          </div>
        `);
      });
      return cards;
    }

    function renderFilters() {
      const options = [{key:'all', label:'All', color:'#555', dot:false}, ...LEAGUES.map(l => ({...l, dot:true}))];
      filtersEl.innerHTML = options.map(opt => {
        const dot = opt.dot ? `<span class="dot"></span>` : '';
        return `<button class="filter-btn ${opt.key===currentFilter?'active':''} ${opt.dot?'':'no-dot'}" data-key="${opt.key}" style="--dot:${opt.color || '#555'}">${dot}${opt.label}</button>`;
      }).join('');
      filtersEl.querySelectorAll('.filter-btn').forEach(btn => {
        btn.onclick = () => {
          currentFilter = btn.dataset.key;
          filtersEl.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderStandings();
        };
      });
    }

    function renderStandings() {
      const cards = [];
      const leagues = currentFilter === 'all' ? LEAGUES : LEAGUES.filter(l => l.key === currentFilter);
      leagues.forEach(lg => {
        const data = standingsData[lg.key];
        if (!data) return;
        const htmlCards = renderLeague(lg, data);
        if (htmlCards && htmlCards.length) cards.push(...htmlCards);
      });
      standingsContainer.innerHTML = cards.join('') || '<p align="center" style="color:#777;">No standings available.</p>';
    }

    async function loadStandings() {
      for (const lg of LEAGUES) {
        standingsData[lg.key] = await fetchLeague(lg);
      }
      renderFilters();
      renderStandings();
    }

    const sb = document.getElementById('nav-scoreboard');
    const st = document.getElementById('nav-standings');
    if (sb && st) {
      st.classList.add('primary');
      st.classList.remove('secondary');
      sb.classList.add('secondary');
      sb.classList.remove('primary');
    }

    loadStandings();
  </script>
</body>
</html>
